# Trade_core

Торговое ядро. Периодически получает последние [биржевые стаканы](https://ru.wikipedia.org/wiki/Биржевой_стакан) и
информацию о балансе связанного шлюза. На их основе принимает решения о выставлении или отмене ордеров и отправляет
соответствующие команды в шлюз.

## Принцип работы

Цель ядра — держать все деньги в лимит-ордерах, в некотором отдалении
от [спреда](https://ru.wikipedia.org/wiki/Спред_(финансы)).

После получения информации о балансе ядро выставляет лимит-ордера на все доступные средства. Цена ордера на покупку
ставится выше текущего лучшего предложения, цена на продажу — ниже.

В момент выставления каждого ордера рассчитываются также _границы удержания_. Это границы, в пределах которых может
колебаться лучшая цена ([аск](https://ru.wikipedia.org/wiki/Аск_(цена)) или [бид](https://ru.wikipedia.org/wiki/Бид)).
Как только лучшая цена выходит за установленные пределы, связанный ордер отменяется, все значения пересчитываются, и
ордер выставляется заново.

Например:

![Ордер на продажу](https://user-images.githubusercontent.com/44947427/152686343-cb49a57c-22bb-41ce-a875-cddcd0bbcedf.svg)

> Границы нужны для того, чтобы снизить частоту выставления ордеров. Если они будут слишком узкими, то ордера будут
> перерассчитываться почти на каждом обновление стакана, и биржа может заблокировать шлюз

## Установка и сборка

Первое, что вам необходимо сделать — собрать [Boost](https://ru.wikipedia.org/wiki/Boost) 1.78.0, включая компонент
Boost.Log. Вы можете найти подробные инструкции на официальном сайте в
разделе [Getting Started on Unix Variants](https://www.boost.org/doc/libs/1_78_0/more/getting_started/unix-variants.html).

Затем можете клонировать код репозитория:

```shell
git clone --recurse-submodules https://gitlab.com/AlgoTech.ru/trade_core.git
```

> Обратите внимание на параметр `--recurse-submodules`. Он нужен, чтобы рекурсивно установить все зависимости
> репозитория, описанные в файле [.gitmodules](.gitmodules)

Сборка осуществляется с использованием утилиты [CMake](https://ru.wikipedia.org/wiki/CMake). Для её упрощения вы можете
воспользоваться скриптом [build.sh](build.sh). После его исполнения собранный код будет находиться в директории
build/Debug:

```shell
./build.sh
```

### Конфигурация ядра

Конфигурация хранится в файле [config.toml](config.toml.example) в формате [TOML](https://ru.wikipedia.org/wiki/TOML). Ядро
будет искать её по относительному пути в рабочей директории. В процессе сборки конфигурация автоматически копируется к
исполняемому файлу.

| Параметр                 | Описание                                                                            | Значение по умолчанию                                                      |
|--------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
| `btc_threshold`          | Пороговое значение BTC, с которого ядро начинает торговать                          | `"0.0008"`                                                                 |
| `usdt_threshold`         | Пороговое значение USDT, с которого ядро начинает торговать                         | `"40"`                                                                     |
| `sell_ratio`             | Коэффициент, на который умножается аск при вычислении цены ордера на продажу        | `"1.0015"`                                                                 |
| `buy_ratio`              | Коэффициент, на который умножается бид при вычислении цены ордера на покупку        | `"0.9985"`                                                                 |
| `lower_bound_ratio`      | Коэффициент, на который умножается аск/бид при вычислении нижней границы удержания  | `"0.9995"`                                                                 |
| `upper_bound_ratio`      | Коэффициент, на который умножается аск/бид при вычислении верхней границы удержания | `"1.0005"`                                                                 |
| `subscribers.*.channel`  | Канал для Aeron Subscriber                                                          | `"aeron:ipc"`                                                              |
| `publishers.*.channel`   | Канал для Aeron Publisher                                                           | <code>"aeron:ipc?control=localhost:40456&#124;control-mode=dynamic"</code> |
| `destinations`           | Список каналов Aeron, которые будут добавлены через метод `addDestination`          | `[]`                                                                       |
| `orderbooks.stream_id`   | Идентификатор потока для канала, по которому принимается биржевой стакан            | `1001`                                                                     |
| `balance.stream_id`      | Идентификатор потока для канала, по которому принимается баланс                     | `1002`                                                                     |
| `gateway.stream_id`      | Идентификатор потока для канала, на который отправляются ордера                     | `1003`                                                                     |
| `metrics.stream_id`      | Идентификатор потока для канала, на который отправляются метрики                    | `1004`                                                                     |
| `errors.stream_id`       | Идентификатор потока для канала, на который отправляются ошибки                     | `1005`                                                                     |
| `idle_strategy_sleep_ms` | Продолжительность для стратегии ожидания Aeron в мс                                 | `1`                                                                        |
| `buffer_size`            | Размер буфера                                                                       | `1400`                                                                     |

### Пример конфигурации systemd

Для настройки автоматического перезапуска кода можно запустить его в качестве
сервиса [systemd](https://ru.wikipedia.org/wiki/Systemd). Если имя вашего пользователя `ubuntu`, конфигурация может
выглядеть следующим образом:

```
[Unit]
Description=Trade Core
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/trade_core/build/Debug
ExecStart=/home/ubuntu/trade_core/build/Debug/trade_core
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

## Логирование

В процессе своей работы ядро генерирует следующие файлы логов:

| Файл                | Содержимое                                                                |
|---------------------|---------------------------------------------------------------------------|
| logs/orderbooks.log | Сообщения, поступившые на канал `orderbooks` (биржевые стаканы от шлюзов) |
| logs/balance.log    | Сообщения, поступившые на канал `balances` (баланс связанного шлюза)      |
| logs/orders.log     | Сообщения, которые ядро отправляет в связанный шлюз (ордера)              |
| logs/errors.log     | Сообщения, которые ядро отправляет в канал ошибок                         |

Содержимое файла logs/orders.log для удобства дублируется на стандартный поток вывода.

## Мониторинг

Для удобства отслеживания ошибок в файле [main.cpp](src/main.cpp) подключён мониторинг
от [Sentry](https://sentry.io/welcome/). Вы можете указать своё значение DSN, изменив константу `SENTRY_DSN`.

Мониторинг будет фиксировать все возникающие ошибки и отправлять их на сервер. По возможности будут прикладываться файлы
логов и конфигурация.

> Если в коде произошла фатальная ошибка, она отправится только при следующем запуске ядра. Поэтому рекомендуется
> настроить автоматический перезапуск
