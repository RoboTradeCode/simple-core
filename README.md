# Trade_core

Торговое ядро. Периодически получает последние [биржевые стаканы](https://ru.wikipedia.org/wiki/Биржевой_стакан) и
информацию о балансе связанного шлюза. На их основе принимает решения о выставлении или отмене ордеров и отправляет
соответствующие команды в шлюз.

## Принцип работы

Цель ядра — держать все деньги в лимит-ордерах, в некотором отдалении
от [спреда](https://ru.wikipedia.org/wiki/Спред_(финансы)).

После получения информации о балансе ядро выставляет лимит-ордера на все доступные средства. Цена ордера на покупку
ставится выше текущего лучшего предложения, цена на продажу — ниже.

> Шлюз считает, что у него есть деньги, только если на его балансе больше 0.0008 BTC или больше 40 USDT

В момент выставления каждого ордера рассчитываются также _границы удержания_. Это границы, в пределах которых может
колебаться лучшая цена ([аск](https://ru.wikipedia.org/wiki/Аск_(цена)) или [бид](https://ru.wikipedia.org/wiki/Бид)).
Как только лучшая цена выходит за установленные пределы, связанный ордер отменяется, все значения пересчитываются, и
ордер выставляется заново.

Например:

![Ордер на продажу](https://user-images.githubusercontent.com/44947427/152686343-cb49a57c-22bb-41ce-a875-cddcd0bbcedf.svg)

> Границы нужны для того, чтобы снизить частоту выставления ордеров. Если они будут слишком узкими, то ордера будут
> перерассчитываться почти на каждом обновление стакана, и биржа может заблокировать шлюз

## Установка и сборка

Первое, что вам необходимо сделать — собрать [Boost](https://ru.wikipedia.org/wiki/Boost) 1.78.0, включая компонент
Boost.Log. Вы можете найти подробные инструкции на официальном сайте в
разделе [Getting Started on Unix Variants](https://www.boost.org/doc/libs/1_78_0/more/getting_started/unix-variants.html).

Затем можете клонировать код репозитория:

```shell
git clone --recurse-submodules https://gitlab.com/AlgoTech.ru/trade_core.git
```

> Обратите внимание на параметр `--recurse-submodules`. Он нужен, чтобы рекурсивно установить все зависимости
> репозитория, описанные в файле [.gitmodules](.gitmodules)

Сборка осуществляется с использованием утилиты [CMake](https://ru.wikipedia.org/wiki/CMake). Для её упрощения вы можете
воспользоваться скриптом [build.sh](build.sh). После его исполнения собранный код будет находиться в директории
build/Debug:

```shell
./build.sh
```

### Конфигурация ядра

Конфигурация хранится в файле [config.toml](config.toml) в формате [TOML](https://ru.wikipedia.org/wiki/TOML). Ядро
будет искать её по относительному пути в рабочей директории. В процессе сборки конфигурации автоматически копируется к
исполняемому файлу.

[//]: # (TODO: Add config description)

### Пример конфигурации systemd

Для настройки автоматического перезапуска кода можно запустить его в качестве
сервиса [systemd](https://ru.wikipedia.org/wiki/Systemd). Если имя вашего пользователя `ubuntu`, конфигурация может
выглядеть следующим образом:

```
[Unit]
Description=Trade Core
After=network.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/trade_core/build/Debug
ExecStart=/home/ubuntu/trade_core/build/Debug/trade_core
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

## Логирование

В процессе своей работы ядро генерирует следующие файлы логов:

- logs/orderbooks.log
- logs/balance.log
- logs/orders.log

Содержимое файла logs/orders.log для удобства дублируется на стандартный поток вывода.

## Мониторинг

Для удобства отслеживания ошибок в файле [main.cpp](src/main.cpp) подключён мониторинг
от [Sentry](https://sentry.io/welcome/). Вы можете указать своё значение DSN, изменив константу `SENTRY_DSN`.

Мониторинг будет фиксировать все возникающие ошибки и отправлять их на сервер. По возможности будут прикладываться файлы
логов и конфигурация.

> Если в коде произошла фатальная ошибка, она отправится только при следующем запуске ядра. Поэтому рекомендуется
> настроить автоматический перезапуск
